# Copilot Instructions for pyresults

## Project Overview
pyresults is a Python application for processing and generating standings for the Oxfordshire Cross Country League. It processes race results from CSV files, calculates individual and team scores across multiple rounds, and produces Excel and PDF outputs with league standings.

## Tech Stack
- **Python**: 3.10+
- **Package Manager**: uv (modern Python package manager)
- **Build System**: hatchling with hatch scripts
- **Key Dependencies**:
  - pandas 2.2.3 - Data processing and CSV handling
  - fpdf 1.7.2 - PDF generation
  - openpyxl 3.1.2 - Excel file creation
  - numpy 1.26.5 - Numerical operations
- **Development Tools**:
  - pytest - Testing framework
  - ruff - Linting and formatting
  - mypy - Type checking
  - pre-commit - Git hooks

## Project Structure
```
pyresults/
├── pyresults/              # Main package
│   ├── __main__.py         # Entry point with CLI argument parsing
│   ├── CONFIG.py           # Configuration constants (categories, divisions, mappings)
│   ├── results.py          # Results class - orchestrates processing and scoring
│   ├── round.py            # Round class - processes individual race rounds
│   ├── race_result.py      # RaceResult class - handles individual race data
│   ├── utils.py            # Utility functions (name cleaning, scoring, exceptions)
│   ├── data_gathering.py   # Data collection utilities
│   ├── create_excel.py     # Excel output generation
│   └── create_pdf.py       # PDF output generation
├── input_data/             # Input CSV files organized by round (r1, r2, etc.)
├── data/                   # Processed output data
│   ├── r1/, r2/, etc.      # Processed results per round
│   └── scores/             # Cumulative standings and team scores
├── tests/                  # Test files
└── pyproject.toml          # Project configuration and dependencies
```

## Key Architecture Patterns

### Data Flow
1. **Input**: CSV files in `input_data/{round}/` containing race results
2. **Processing**: 
   - Round → RaceResult (per race) → normalize & clean data
   - Results class aggregates across rounds and calculates scores
3. **Output**: 
   - Processed CSVs in `data/`
   - Excel workbook with multiple sheets
   - PDF document with formatted tables

### Class Responsibilities
- **Results**: Static class methods for orchestrating entire processing pipeline
- **Round**: Loads all race results for a specific round
- **RaceResult**: Handles individual race CSV parsing, cleaning, and team calculations
- **Publisher**: Coordinates Excel and PDF output generation

### Scoring Logic
- Individual scores: Sum of best positions across rounds (e.g., best 4 of 5)
- Team scores: Sum of top N runners' positions (varies by category)
- Missing rounds: Assigned penalty score (99999) 
- Guest runners: Excluded from results (defined in `CONFIG.GUESTS`)

## Coding Conventions

### Python Style
- Follow PEP 8 guidelines
- Use type hints where appropriate (Python 3.10+ syntax)
- Prefer class methods and static methods for stateless operations
- Keep functions focused and single-purpose

### Data Processing
- Always use pandas for CSV operations
- Clean athlete names using `utils.clean_name()`
- Convert times to `timedelta` objects for proper handling
- Use `.astype(str)` for race numbers to preserve leading zeros
- Filter guests before position calculations using `CONFIG.GUESTS`

### File Handling
- Use `pathlib.Path` for file path operations
- Use absolute paths from `Path(__file__).parent.parent`
- Create output directories with `mkdir(parents=True, exist_ok=True)`
- Handle encoding with `encoding="utf-16"` for input CSVs

### Error Handling
- Wrap exceptions with informative error messages
- Use try/except for file operations and encoding detection
- Continue processing other races even if one fails
- Apply race-specific exceptions via `utils.handle_exceptions()`

### Configuration
- All categories, mappings, and divisions in `CONFIG.py`
- Use dictionary lookups for gender/category mappings
- Team sizes and scoring rules defined per race type
- Round numbers managed as list in Results class

## Common Tasks

### Adding a New Category
1. Add category code to `CONFIG.CATEGORIES`
2. Add gender mapping to `CONFIG.GENDER_MAPPINGS` (if needed)
3. Add category mapping to `CONFIG.CATEGORY_MAPPINGS`
4. Add race mapping to `CONFIG.RACE_MAPPINGS`
5. Update team calculations if it's a team category

### Handling Data Exceptions
- Add athlete corrections in `utils.handle_exceptions()`
- Use `insert_athlete_into_df()` for missing runners
- Filter out incorrect entries by race number
- Always call `reset_positions()` after modifications

### Generating Output
- Excel: One sheet per category (individual + team scores)
- PDF: Formatted tables with headers/footers, automatic pagination
- Both outputs read from `data/scores/` directory

## Development Workflow

### Setup
```bash
# Install uv package manager (Windows)
powershell -ExecutionPolicy ByPass -c "irm https://astral.sh/uv/install.ps1 | iex"

# Install dependencies
uv sync --all-extras
```

### Running
```bash
# Run with default settings (all rounds)
uv run python -m pyresults

# Process specific rounds
uv run python -m pyresults --rounds r1 r2 r3

# Skip Excel/PDF generation
uv run python -m pyresults --excel False --pdf False
```

### Testing & Quality
```bash
uv run hatch test          # Run tests
uv run hatch lint          # Check code quality
uv run hatch format        # Format code
uv run hatch pre-commit    # Run all pre-commit hooks
```

### Building
```bash
uv run hatch build         # Build wheel distribution
```

## Important Notes

### Data Integrity
- Guest runners MUST be excluded before position calculations
- Position resets required after filtering or insertions
- Category determination depends on gender + age group
- Team scores use gender position (Gen Pos), not category position

### CSV Encoding
- Input files use UTF-16 encoding
- Some files may be tab-separated instead of comma-separated
- RaceResult detects and handles both formats automatically

### Scoring Rules
- Individual: Best N-1 rounds count (e.g., best 4 of 5 rounds)
- Teams: Sum of top runners' positions (3-7 depending on category)
- Penalty score: One more than last gender position
- Incomplete teams: Score set to NA/empty

### Division Assignment
- Men's and Women's teams assigned to divisions 1-3
- Division mappings in `CONFIG.MENS_DIVISIONS` and `CONFIG.WOMENS_DIVISIONS`
- Teams not in mappings default to division 3
- Youth categories don't have divisions

## Testing Strategy
- Acceptance tests in `tests/acceptance/`
- Test data processing logic with sample CSV files
- Verify scoring calculations across multiple rounds
- Validate Excel and PDF output generation

## Dependencies Management
- Use `uv` for all package management
- Run `uv sync` after pulling changes
- Add new dependencies with `uv add <package>`
- Dev dependencies in `[dependency-groups.dev]`

## Type Checking
- Mypy configured for type checking
- Target Python 3.10+
- Include `pyresults/` in type checking
- Run via pre-commit hooks or manually with `uv run mypy pyresults/`

## Output Files
- **Excel**: `data/OxfordshireCrossCountryLeagueStandings.xlsx`
- **PDF**: Generated with league branding and formatting
- **CSV Scores**: Individual and team scores in `data/scores/`

## When Making Changes
1. Update `CONFIG.py` for any rule or mapping changes
2. Ensure data cleaning utilities are applied consistently
3. Test with actual race data from multiple rounds
4. Verify both individual and team scoring outputs
5. Check Excel and PDF generation still work
6. Run linter and formatter before committing
7. Update version in `__about__.py` if needed

## Special Considerations
- Race-specific exceptions are hardcoded in `utils.handle_exceptions()`
- Some athlete names contain special characters (use `clean_name()`)
- Team names must match exactly for division assignment
- Gender position (Gen Pos) differs from category position (Cat Pos)
- Background knowledge of cross country league scoring is helpful
